<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=theme-color content="dark"><title>Caddy2 + Hugo + Github Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²åšå®¢æ–¹æ¡ˆ | Lim's Blog</title><meta property="og:site_name" content><meta property="og:title" content="Caddy2 + Hugo + Github Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²åšå®¢æ–¹æ¡ˆ | Lim's Blog"><meta itemprop=name content="Caddy2 + Hugo + Github Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²åšå®¢æ–¹æ¡ˆ | Lim's Blog"><meta name=twitter:title content="Caddy2 + Hugo + Github Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²åšå®¢æ–¹æ¡ˆ | Lim's Blog"><meta name=application-name content="Caddy2 + Hugo + Github Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²åšå®¢æ–¹æ¡ˆ | Lim's Blog"><meta name=description content><meta name=twitter:description content><meta itemprop=description content><meta property="og:description" content><meta property="og:type" content="article"><meta property="article:publisher" content><meta property="og:article:published_time" content="2021-05-08T18:35:53+0800"><meta property="article:published_time" content="2021-05-08T18:35:53+0800"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"Caddy2 + Hugo + Github Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²åšå®¢æ–¹æ¡ˆ","author":{"@type":"Person","name":""},"datePublished":"2021-05-08","description":"","wordCount":260,"mainEntityOfPage":"True","dateModified":"2021-05-08","publisher":{"@type":"Organization","name":"","logo":{"@type":"imageObject","url":"favicon.ico"}}}</script><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=stylesheet href=/sass/main.min.1d88a8c207da218e24d4bcd30e2d1320ce0da4fe18fcbbc94a3f3285e6250848.css></head><body class=dark><nav class=navbar><div class=container><div class=flex><div><a class=brand href=/><span class=emoji>ğŸ˜</span>
Lim's Blog</a></div><div class=flex><a href=/articles/>Articles</a>
<button id=dark-mode-button><svg class="light" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform:rotate(360deg);-webkit-transform:rotate(360deg);transform:rotate(360deg)" viewBox="0 0 36 36"><path fill="#ffd983" d="M30.312.776C32 19 20 32 .776 30.312c8.199 7.717 21.091 7.588 29.107-.429C37.9 21.867 38.03 8.975 30.312.776z"/><path d="M30.705 15.915a1.163 1.163.0 101.643 1.641 1.163 1.163.0 00-1.643-1.641zm-16.022 14.38a1.74 1.74.0 000 2.465 1.742 1.742.0 100-2.465zm13.968-2.147a2.904 2.904.0 01-4.108.0 2.902 2.902.0 010-4.107 2.902 2.902.0 014.108.0 2.902 2.902.0 010 4.107z" fill="#ffcc4d"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)"/></svg><svg class="dark" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform:rotate(360deg);-webkit-transform:rotate(360deg);transform:rotate(360deg)" viewBox="0 0 36 36"><path fill="#ffd983" d="M16 2s0-2 2-2 2 2 2 2v2s0 2-2 2-2-2-2-2V2zm18 14s2 0 2 2-2 2-2 2h-2s-2 0-2-2 2-2 2-2h2zM4 16s2 0 2 2-2 2-2 2H2s-2 0-2-2 2-2 2-2h2zm5.121-8.707s1.414 1.414.0 2.828-2.828.0-2.828.0L4.878 8.708s-1.414-1.414.0-2.829c1.415-1.414 2.829.0 2.829.0l1.414 1.414zm21 21s1.414 1.414.0 2.828-2.828.0-2.828.0l-1.414-1.414s-1.414-1.414.0-2.828 2.828.0 2.828.0l1.414 1.414zm-.413-18.172s-1.414 1.414-2.828.0.0-2.828.0-2.828l1.414-1.414s1.414-1.414 2.828.0.0 2.828.0 2.828l-1.414 1.414zm-21 21s-1.414 1.414-2.828.0.0-2.828.0-2.828l1.414-1.414s1.414-1.414 2.828.0.0 2.828.0 2.828l-1.414 1.414zM16 32s0-2 2-2 2 2 2 2v2s0 2-2 2-2-2-2-2v-2z"/><circle fill="#ffd983" cx="18" cy="18" r="10"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)"/></svg></button></div></div></div></nav><main><div class=container><article><header class=article-header><div class=thumb><div><h1>Caddy2 + Hugo + Github Actions çš„è‡ªåŠ¨åŒ–éƒ¨ç½²åšå®¢æ–¹æ¡ˆ</h1><div class=post-meta><div>By on <time>May 08, 2021</time></div><div class=tags><a href=/tags/caddy/>Caddy</a>
<a href=/tags/hugo/>Hugo</a>
<a href=/tags/github-actions/>GitHub Actions</a></div></div></div></div></header></article><div class=article-post><p>æˆ‘çš„åšå®¢éƒ¨ç½²æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å†™æ–‡ç« å¹¶æ¨é€åˆ° <code>username.github.io</code> ä»“åº“çš„ <code>hugo</code> åˆ†æ”¯ã€‚</li><li>GitHub Actions è‡ªåŠ¨æ„å»ºå¹¶æ¨é€åˆ° <code>main</code> åˆ†æ”¯ã€‚</li><li>GitHub å‘é€ webhook è¯·æ±‚åˆ°è‡ªæœ‰æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ‹‰å–æ›´æ–°ã€‚</li></ol><p>ä¸ä½¿ç”¨ GitHub Page çš„åŸå› ä¸»è¦æ˜¯åœ¨å›½å†…è®¿é—®å¤ªæ…¢ï¼Œè€Œä¸”æœ‰æœåŠ¡å™¨é—²ç½®ï¼Œæ­£å¥½ç”¨æ¥éƒ¨ç½²åšå®¢ã€‚</p><p>è€Œä½¿ç”¨ GitHub Actions å…ˆæ„å»ºæ¨é€åˆ° <code>main</code>ï¼Œç„¶åå†åœ¨æœåŠ¡å™¨ä¸Šæ‹‰å–çš„åŸå› æ˜¯å¯ä»¥åœ¨ GitHub Page ä¸Šæœ‰ä¸€ä¸ªå¤‡ä»½ï¼ŒæœåŠ¡å™¨å‡ºç°æ•…éšœæ—¶å¯ä»¥å…ˆ 302 é‡å®šå‘åˆ° GitHub Pageï¼Œè§£å†³æ•…éšœååˆ‡æ¢å›æ¥ã€‚</p><p>ä¸ºäº†å®ç°è¿™ä¸ªæµç¨‹ï¼Œåœ¨æœåŠ¡å™¨ä¸Šéœ€è¦ç”¨åˆ°ä¸€ä¸ªæœåŠ¡ï¼šCaddy</p><p>Caddy æ˜¯åŸºäº go ç¼–å†™çš„ web æœåŠ¡å™¨ï¼Œç›¸æ¯”äº nginx å’Œ apache çš„ä¼˜ç‚¹å°±æ˜¯èƒ½è‡ªåŠ¨ç”³è¯· SSL è¯ä¹¦ï¼Œè‡ªåŠ¨æ›´æ–°è¯ä¹¦ã€‚</p><p>å½“ç„¶ï¼Œæœ‰äººä¼šè¯´è¿™ç±»æ–‡ç« ç½‘ä¸Šå·²ç»æœ‰å¾ˆå¤šäº†ï¼Œä¸ºä»€ä¹ˆè¿˜è¦é‡å¤å†å†™ä¸€ç¯‡ã€‚ä¸€ä¸ªé‡è¦çš„åŸå› æ˜¯ç½‘ä¸Šçš„çš„æ–‡ç« éƒ½æ˜¯åŸºäº Caddy V1 ç‰ˆæœ¬ï¼Œè€Œåœ¨ Caddy æ›´æ–°åˆ° V2 ç‰ˆæœ¬åï¼Œä¹‹å‰çš„æ’ä»¶éƒ½å·²ç»å¤±æ•ˆäº†ã€‚</p><p>æœ¬ç€ç”¨æ–°ä¸ç”¨æ—§çš„åŸåˆ™ï¼Œæˆ‘ä¹Ÿå°† Caddy æ›´æ–°åˆ° V2ï¼Œä½†ä¹Ÿå› ä¸ºè¿™æ ·éœ€è¦é‡æ–°é…ç½®ç¬¬ 3 æ­¥çš„éƒ¨ç½²æµç¨‹ã€‚</p><p>ä¸ºäº†å®ç°ç¬¬ 3 æ­¥ï¼Œæˆ‘ç»™ Caddy å†™äº†ä¸€ä¸ªæ¨¡å—ï¼š<a href=https://github.com/WingLim/caddy-webhook>caddy-webhook</a>ï¼Œä¸‹é¢é€šè¿‡å…·ä½“çš„æ­¥éª¤æ¥å±•ç¤ºå¦‚ä½•ä½¿ç”¨è¿™ä¸ªæ¨¡å—ã€‚</p><h3 id=å»ºç«‹ä»“åº“>å»ºç«‹ä»“åº“</h3><p>å»ºç«‹ä¸€ä¸ª <code>username.github.io</code> çš„ä»“åº“ä¼šè‡ªåŠ¨é…ç½® GitHub Pageï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç›´æ¥è®¿é—® <code>username.github.io</code> æ¥è®¿é—®åˆ° <code>main</code> åˆ†æ”¯ä¸­çš„é™æ€é¡µé¢ã€‚</p><p>å…‹éš†ä»“åº“å¹¶è¿›å…¥</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>git clone username.github.io
<span class=nb>cd</span> username.github.io
</code></pre></div><p>æ–°å»ºå¹¶åˆ‡æ¢åˆ° <code>hugo</code> åˆ†æ”¯</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>git checkout -b hugo
</code></pre></div><p>åœ¨å½“å‰ç›®å½•åˆ›å»ºä¸€ä¸ª hugo ç«™ç‚¹</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>hugo new site .
</code></pre></div><p>ç„¶åå°±å¯ä»¥åœ¨ <code>hugo</code> åˆ†æ”¯ä¸­æ’°å†™æ–‡ç« äº†</p><h3 id=ä½¿ç”¨-github-actions>ä½¿ç”¨ GitHub Actions</h3><p>åˆ›å»º github workflows æ–‡ä»¶å¤¹</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mkdir -p .github/workflows
</code></pre></div><p>è¿›å…¥ workflows æ–‡ä»¶å¤¹å¹¶æ–°å»º <code>hugo</code> å·¥ä½œæµ</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> .github/workflows
touch hugo.yml
</code></pre></div><p><code>hugo.yml</code> å†…å®¹å¦‚ä¸‹ï¼š</p><p>å› ä¸ºåœ¨ Hugo ç«™ç‚¹ä¸­ï¼Œå¤§å¤šæ•°äººéƒ½æ˜¯ä½¿ç”¨ <code>submodule</code> æ¥é…ç½®ä¸»é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨ <code>checkout@v2</code> çš„ <code>submodules: 'recursive'</code> æ¥è·å–ä¸»é¢˜ï¼Œå¦åˆ™åœ¨æ„å»ºåšå®¢æ—¶ä¼šæ— æ³•æ‰¾åˆ°ä¸»é¢˜æ¨¡ç‰ˆè€Œæ— æ³•ç”Ÿæˆé™æ€é¡µé¢ã€‚</p><p>åŒæ—¶æ¨èä½¿ç”¨ <code>extended</code> ç‰ˆæœ¬çš„ Hugoï¼Œé™„å¸¦äº† scss çš„åŠŸèƒ½ï¼Œä»¥å…ä½¿ç”¨çš„ä¸»é¢˜æ²¡æœ‰æä¾›ç¼–è¯‘åçš„ css æ–‡ä»¶ã€‚</p><p><code>secrets.GITHUB_TOKEN</code> æ˜¯ GitHub Actions ä¸­è‡ªå¸¦çš„ï¼Œæ— éœ€å†æ‰‹åŠ¨é…ç½®ã€‚</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy Hugo to Github Pages</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>on</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>push</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>branches</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>hugo</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>build-deploy</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-latest</span><span class=w>
</span><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@v2</span><span class=w>
</span><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span><span class=w>           </span><span class=nt>submodules</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;recursive&#39;</span><span class=w>
</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Setup Hugo</span><span class=w>
</span><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>peaceiris/actions-hugo@v2</span><span class=w>
</span><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>hugo-version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;0.83.1&#39;</span><span class=w>
</span><span class=w>          </span><span class=nt>extended</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Build</span><span class=w>
</span><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>hugo --minify</span><span class=w>
</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy</span><span class=w>
</span><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>peaceiris/actions-gh-pages@v3</span><span class=w>
</span><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>github_token</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.GITHUB_TOKEN }}</span><span class=w>
</span><span class=w>          </span><span class=nt>publish_dir</span><span class=p>:</span><span class=w> </span><span class=l>./public</span><span class=w>
</span><span class=w>          </span><span class=nt>publish_branch</span><span class=p>:</span><span class=w> </span><span class=l>main</span><span class=w>
</span></code></pre></div><h3 id=éƒ¨ç½²-caddy>éƒ¨ç½² Caddy</h3><p>åˆ›å»ºæ–‡ä»¶å¤¹ç”¨äºä¿å­˜ Caddy çš„æ–‡ä»¶æ•°æ®</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mkdir -p caddy/data
</code></pre></div><p>åˆå§‹åŒ–æ—¥å¿—åŠé…ç½®æ–‡ä»¶</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> caddy
touch access.log
touch Caddyfile
</code></pre></div><p>ä½¿ç”¨ docker è¿›è¡Œéƒ¨ç½²ï¼Œ<code>winglim/caddy</code> æ˜¯æˆ‘æ„å»ºçš„åŒ…å«äº† <code>caddy-webhook</code> æ¨¡å—çš„é•œåƒã€‚</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker run -itd <span class=se>\
</span><span class=se></span>    -p 80:80 -p 443:443
    -v <span class=nv>$PWD</span>/Caddyfile:/etc/caddy/Caddyfile <span class=se>\
</span><span class=se></span>    -v <span class=nv>$PWD</span>/access.log:/var/log/access.log <span class=se>\
</span><span class=se></span>    -v <span class=nv>$PWD</span>/data:/data<span class=se>\
</span><span class=se></span>    winglim/caddy
</code></pre></div><p>å¦‚æœä¸æƒ³ä½¿ç”¨ docker è¿›è¡Œéƒ¨ç½²çš„è¯ï¼Œå¯ä»¥è‡ªå·±æ‰‹åŠ¨ç¼–è¯‘ä¸€ä¸ªå¸¦ <code>caddy-webhook</code> æ¨¡å—çš„ caddy</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># æ³¨æ„ go install package@tag åªåœ¨ go 1.16 åŠä»¥ä¸Šç‰ˆæœ¬æ‰æ”¯æŒ</span>
go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest
<span class=c1># ä½äº go 1.16 ç‰ˆæœ¬è¯·ä½¿ç”¨ go get</span>
go get -v github.com/caddyserver/xcaddy/cmd/xcaddy@latest

xcaddy build <span class=se>\
</span><span class=se></span>	--with github.com/WingLim/caddy-webhook
</code></pre></div><p><code>Caddyfile</code> å†…å®¹å¦‚ä¸‹ï¼š</p><div class=highlight><pre class=chroma><code class=language-Caddyfile data-lang=Caddyfile><span class=gh>example.com</span> <span class=p>{</span>
  <span class=k>tls</span> <span class=s>yourmail@example.com</span>
  <span class=k>encode</span> <span class=s>zstd</span> <span class=s>gzip</span>

  <span class=k>log</span> <span class=p>{</span>
    <span class=k>output</span> <span class=s>file</span> <span class=s>/var/log/access.log</span>
  <span class=p>}</span>

  <span class=k>root</span> <span class=s>blog</span>
  <span class=k>file_server</span>
  
  <span class=k>route</span> <span class=nd>/webhook</span> <span class=p>{</span>
    <span class=k>webhook</span> <span class=p>{</span>
      <span class=k>repo</span> <span class=s>https://github.com/username/username.github.io.git</span>
      <span class=k>branch</span> <span class=s>main</span>
      <span class=k>path</span> <span class=s>blog</span>
      <span class=k>secret</span> <span class=s>yoursecret</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>æœ€åï¼Œæˆ‘ä»¬å°±å®ç°äº†æ–‡ç« å¼€å¤´æ‰€è¯´çš„å·¥ä½œæµç¨‹ï¼Œå‰©ä¸‹çš„å°±æ˜¯å†™ä¸€äº›æœ‰ä»·å€¼çš„æ–‡ç« äº†ã€‚</p></div></div><div class=container><nav class="flex container suggested"><a rel=prev href=/post/build-docker-image-in-multi-archs-with-github-actions/ title="Previous post (older)"><span>Previous</span>
ä½¿ç”¨ GiHub Actions æ„å»ºå¤šæ¶æ„ Docker é•œåƒ</a></nav></div></main></main><footer class="footer flex"><section class=container><nav class=footer-links><a href=/index.xml>RSS</a></nav></section><script async src=/ts/features.aae54872a4ce10f31183401ffe494fdc7160fa4925869741aee7ab580afc9908.js data-enable-footnotes=true></script></footer></body></html>