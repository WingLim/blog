<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=theme-color content="dark"><title>Linux Kernel å®è·µ(ä¸€)ï¼šHello LKM | Lim's Blog</title><link rel=stylesheet href=/sass/main.min.14967ba2ef1bc4295b0586f1b2b13b4bae44300f5973bfb61b5c52c844f54ab6.css></head><body class=dark><nav class=navbar><div class=container><div class=flex><div><a class=brand href=/><span class=emoji>ğŸ˜</span>
Lim's Blog</a></div><div class=flex><a href=/articles/>Articles</a>
<button id=dark-mode-button></button></div></div></div></nav><main><div class=container><article><header class=article-header><div class=thumb><div><h1>Linux Kernel å®è·µ(ä¸€)ï¼šHello LKM</h1><div class=post-meta><div>By on <time>March 06, 2020</time></div><div class=tags><a href=/tags/kernel/>Kernel</a>
<a href=/tags/linux/>Linux</a>
<a href=/tags/module/>Module</a></div></div></div></div></header></article><div class=article-post><p>å®ç°ä¸€ä¸ªç®€å•çš„ Linux Kernel Module å¹¶é€šè¿‡è‡ªå®šä¹‰å‚æ•°è¾“å‡ºä¿¡æ¯ã€‚</p><p>ä½¿ç”¨ç³»ç»Ÿä¸º Ubuntuï¼Œå†…æ ¸ç‰ˆæœ¬ä¸º 4.4.0-93-generic</p><h2 id=ä»€ä¹ˆæ˜¯å†…æ ¸æ¨¡å—>ä»€ä¹ˆæ˜¯å†…æ ¸æ¨¡å—</h2><p>Loadable Kernel Modulesï¼ˆLKMï¼‰å³å¯åŠ è½½å†…æ ¸æ¨¡å—ï¼ŒLKMå¯ä»¥åŠ¨æ€åœ°åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œæ— é¡»é‡æ–°ç¼–è¯‘å†…æ ¸ã€‚æ‰€ä»¥å®ƒç»å¸¸è¢«ç”¨äºä¸€äº›è®¾å¤‡çš„é©±åŠ¨ç¨‹åºï¼Œä¾‹å¦‚å£°å¡ï¼Œç½‘å¡ç­‰ç­‰ã€‚</p><p>å†…æ ¸æ¨¡å—å’Œä¸€èˆ¬çš„ C è¯­è¨€ç¨‹åºä¸åŒï¼Œå®ƒä¸ä½¿ç”¨ <code>main()</code> å‡½æ•°ä½œä¸ºå…¥å£ï¼Œå¹¶ä¸”æœ‰å¦‚ä¸‹åŒºåˆ«ï¼š</p><ul><li>éé¡ºåºæ‰§è¡Œï¼šå†…æ ¸æ¨¡å—ä½¿ç”¨åˆå§‹åŒ–å‡½æ•°æ¥è¿›è¡Œæ³¨å†Œï¼Œå¹¶å¤„ç†è¯·æ±‚ï¼Œåˆå§‹åŒ–å‡½æ•°è¿è¡Œåå°±ç»“æŸäº†ã€‚ å®ƒå¯ä»¥å¤„ç†çš„è¯·æ±‚ç±»å‹åœ¨æ¨¡å—ä»£ç ä¸­å®šä¹‰ã€‚</li><li>æ²¡æœ‰è‡ªåŠ¨æ¸…ç†ï¼šå†…æ ¸æ¨¡å—ç”³è¯·çš„æ‰€æœ‰å†…å­˜ï¼Œå¿…é¡»è¦åœ¨æ¨¡å—å¸è½½æ—¶æ‰‹åŠ¨é‡Šæ”¾ï¼Œå¦åˆ™è¿™äº›å†…å­˜ä¼šæ— æ³•ä½¿ç”¨ï¼Œç›´åˆ°é‡å¯ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦åœ¨æ¨¡å—çš„å¸è½½å‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯ä¸‹æ–‡å†™åˆ°çš„é€€å‡ºå‡½æ•°ï¼‰ä¸­ï¼Œå°†ä½¿ç”¨çš„å†…å­˜é€ä¸€é‡Šæ”¾ã€‚</li><li>ä¼šè¢«ä¸­æ–­ï¼šå†…æ ¸æ¨¡å—å¯èƒ½ä¼šåŒæ—¶è¢«å¤šä¸ªç¨‹åº/è¿›ç¨‹ä½¿ç”¨ï¼Œæ„å»ºå†…æ ¸æ¨¡å—æ—¶è¦ç¡®ä¿å‘ç”Ÿä¸­æ–­æ—¶è¡Œä¸ºä¸€è‡´å’Œæ­£ç¡®ã€‚æƒ³äº†è§£æ›´å¤šè¯·çœ‹ï¼š<a href=https://www.cnblogs.com/linfeng-learning/p/9512866.html>Linux å†…æ ¸çš„ä¸­æ–­æœºåˆ¶</a></li><li>æ›´é«˜çº§çš„æ‰§è¡Œç‰¹æƒï¼šé€šå¸¸åˆ†é…ç»™å†…æ ¸æ¨¡å—çš„CPUå‘¨æœŸæ¯”åˆ†é…ç»™ç”¨æˆ·ç©ºé—´ç¨‹åºçš„è¦å¤šã€‚ç¼–å†™å†…æ ¸æ¨¡å—æ—¶è¦å°å¿ƒï¼Œä»¥å…æ¨¡å—å¯¹ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ã€‚</li><li>ä¸æ”¯æŒæµ®ç‚¹ï¼šåœ¨Linuxå†…æ ¸é‡Œæ— æ³•ç›´æ¥è¿›è¡Œæµ®ç‚¹è®¡ç®—ï¼Œå› ä¸ºè¿™æ ·åšå¯ä»¥çœå»åœ¨ç”¨æˆ·æ€ä¸å†…æ ¸æ€ä¹‹é—´è¿›è¡Œåˆ‡æ¢æ—¶ä¿å­˜/æ¢å¤æµ®ç‚¹å¯„å­˜å™¨ FPUçš„æ“ä½œã€‚</li></ul><h2 id=æ„å»ºå‰çš„å‡†å¤‡>æ„å»ºå‰çš„å‡†å¤‡</h2><p>é€šè¿‡åŒ…ç®¡ç†å®‰è£… Linux å†…æ ¸å¤´æ–‡ä»¶</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo apt update
$ apt-cache search linux-headers-<span class=k>$(</span>uname -r<span class=k>)</span>
$ apt install linux-headers-<span class=k>$(</span>uname -r<span class=k>)</span>
</code></pre></td></tr></table></div></div><h2 id=å¼€å§‹å†™ä»£ç >å¼€å§‹å†™ä»£ç </h2><h3 id=å¼•å…¥å¤´æ–‡ä»¶>å¼•å…¥å¤´æ–‡ä»¶</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;linux/init.h&gt; // ç”¨äºæ ‡è®°å‡½æ•°çš„å®</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;linux/module.h&gt; //åŠ è½½å†…æ ¸æ¨¡å—åˆ°å†…æ ¸ä½¿ç”¨çš„æ ¸å¿ƒå¤´æ–‡ä»¶</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;linux/kernel.h&gt; // åŒ…å«å†…æ ¸ä½¿ç”¨çš„ç±»å‹ã€å®å’Œå‡½æ•°</span><span class=cp>
</span></code></pre></td></tr></table></div></div><h3 id=å®šä¹‰æ¨¡å—ä¿¡æ¯>å®šä¹‰æ¨¡å—ä¿¡æ¯</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=n>MODULE_LICENSE</span><span class=p>(</span><span class=s>&#34;GPL&#34;</span><span class=p>);</span>              <span class=c1>// è®¸å¯ç±»å‹ï¼Œå®ƒä¼šå½±å“åˆ°è¿è¡Œæ—¶è¡Œä¸º 
</span><span class=c1></span><span class=n>MODULE_AUTHOR</span><span class=p>(</span><span class=s>&#34;WingLim&#34;</span><span class=p>);</span>      <span class=c1>// ä½œè€…ï¼Œå½“ä½¿ç”¨ modinfo å‘½ä»¤æ—¶å¯è§ 
</span><span class=c1></span><span class=n>MODULE_DESCRIPTION</span><span class=p>(</span><span class=s>&#34;A simple Linux driver to say hello.&#34;</span><span class=p>);</span>  <span class=c1>// æ¨¡å—æè¿°ï¼Œå‚è§ modinfo å‘½ä»¤ 
</span><span class=c1></span><span class=n>MODULE_VERSION</span><span class=p>(</span><span class=s>&#34;0.1&#34;</span><span class=p>);</span>              <span class=c1>// æ¨¡å—ç‰ˆæœ¬ 
</span></code></pre></td></tr></table></div></div><p>å¦‚æœæ²¡æœ‰å®šä¹‰ <code>MODULE_LICENSE</code> ï¼Œåœ¨ç¼–è¯‘å’ŒåŠ è½½æ¨¡å—æ—¶ä¼šæŠ¥ <code>WARNING: modpost: missing MODULE_LICENSE()</code></p><p><code>MODULE_LICENSE</code> å¯ä»¥é€‰ç”¨ â€œGPLâ€ï¼Œâ€œGPL v2â€ï¼Œâ€œGPL and additional rightsâ€ï¼Œâ€œDual BSD/GPLâ€ï¼Œâ€œDual MPL/GPLâ€ï¼Œâ€œProprietaryâ€ è¿™å‡ ä¸ªè®¸å¯è¯ã€‚æ›´å¤šè¯´æ˜è¯·çœ‹ï¼š<a href=https://elixir.bootlin.com/linux/v4.4/source/include/linux/module.h#L209>linux/module.h#L209</a></p><h3 id=åˆå§‹åŒ–å‡½æ•°>åˆå§‹åŒ–å‡½æ•°</h3><p><code>static</code> é™åˆ¶è¿™ä¸ªå‡½æ•°çš„å¯è§èŒƒå›´ä¸ºå½“å‰ C æ–‡ä»¶</p><p><code>__init</code> è¡¨ç¤ºè¯¥å‡½æ•°ä»…åœ¨åˆå§‹åŒ–é˜¶æ®µä½¿ç”¨ï¼Œä¹‹åé‡Šæ”¾ä½¿ç”¨çš„å†…å­˜èµ„æºï¼š<a href=https://elixir.bootlin.com/linux/v4.4/source/include/linux/init.h#L7>init.h#L7</a></p><p><code>@return</code> æ‰§è¡ŒæˆåŠŸè¿”å› 0</p><p>åœ¨å†…æ ¸ä¸­æˆ‘ä»¬ä½¿ç”¨ <code>printk()</code> æ¥æ‰“å°ä¿¡æ¯.ã€‚<code>printk()</code> å’Œ <code>printf()</code> è¯­æ³•ä¸€æ ·ï¼Œä½†éœ€è¦å…ˆå®šä¹‰æ¶ˆæ¯ç±»å‹ã€‚å¯ç”¨çš„æ¶ˆæ¯ç±»å‹å¯ä»¥åˆ° <a href=https://elixir.bootlin.com/linux/v4.4/source/include/linux/kern_levels.h#L7>linux/kern_levels.h#L7-#L23</a> æŸ¥çœ‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=k>static</span> <span class=kt>int</span> <span class=n>__init</span> <span class=nf>helloModule_init</span><span class=p>(</span><span class=kt>void</span><span class=p>){</span>
   <span class=n>printk</span><span class=p>(</span><span class=n>KERN_INFO</span> <span class=s>&#34;Hello LKM!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
   <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h3 id=é€€å‡ºå‡½æ•°>é€€å‡ºå‡½æ•°</h3><p><code>__exit</code> è¡¨ç¤ºå¦‚æœè¿™ä¸ªä»£ç ç”¨äºä¸€ä¸ªå†…ç½®çš„é©±åŠ¨ç¨‹åº(è€Œä¸æ˜¯LKM)ï¼Œåˆ™ä¸éœ€è¦è¿™ä¸ªå‡½æ•°ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=k>static</span> <span class=kt>void</span> <span class=n>__exit</span> <span class=nf>helloModule_exit</span><span class=p>(</span><span class=kt>void</span><span class=p>){</span>
   <span class=n>printk</span><span class=p>(</span><span class=n>KERN_INFO</span> <span class=s>&#34;Goodbye LKM!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h3 id=åˆå§‹åŒ–é€€å‡ºæ¨¡å—>åˆå§‹åŒ–&é€€å‡ºæ¨¡å—</h3><p>å®šä¹‰åœ¨ <a href=https://elixir.bootlin.com/linux/v4.4/source/include/linux/module.h#L75>linux/module.h#L75-#L98</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=n>module_init</span><span class=p>(</span><span class=n>helloModule_init</span><span class=p>);</span>
<span class=n>module_exit</span><span class=p>(</span><span class=n>helloModule_exit</span><span class=p>);</span>
</code></pre></td></tr></table></div></div><h4 id=æ±‡æ€»>æ±‡æ€»</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=cm>/*hello.c*/</span>
<span class=cp>#include</span> <span class=cpf>&lt;linux/init.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;linux/module.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;linux/kernel.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=n>MODULE_LICENSE</span><span class=p>(</span><span class=s>&#34;GPL&#34;</span><span class=p>);</span>
<span class=n>MODULE_AUTHOR</span><span class=p>(</span><span class=s>&#34;WingLim&#34;</span><span class=p>);</span>
<span class=n>MODULE_DESCRIPTION</span><span class=p>(</span><span class=s>&#34;A simple Linux driver to say hello.&#34;</span><span class=p>);</span>
<span class=n>MODULE_VERSION</span><span class=p>(</span><span class=s>&#34;0.1&#34;</span><span class=p>);</span>

<span class=k>static</span> <span class=kt>int</span> <span class=n>__init</span> <span class=nf>helloModule_init</span><span class=p>(</span><span class=kt>void</span><span class=p>){</span>
   <span class=n>printk</span><span class=p>(</span><span class=n>KERN_INFO</span> <span class=s>&#34;Hello LKM!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
   <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>static</span> <span class=kt>void</span> <span class=n>__exit</span> <span class=nf>helloModule_exit</span><span class=p>(</span><span class=kt>void</span><span class=p>){</span>
   <span class=n>printk</span><span class=p>(</span><span class=n>KERN_INFO</span> <span class=s>&#34;Goodbye LKM!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>module_init</span><span class=p>(</span><span class=n>helloModule_init</span><span class=p>);</span>
<span class=n>module_exit</span><span class=p>(</span><span class=n>helloModule_exit</span><span class=p>);</span>
</code></pre></td></tr></table></div></div><h2 id=ç¼–è¯‘>ç¼–è¯‘</h2><p>æ·»åŠ  <code>Makefile</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-makefile data-lang=makefile><span class=nv>obj-m</span><span class=o>+=</span>hello.o
<span class=nv>KDIR</span> <span class=o>=</span> /lib/modules/<span class=k>$(</span>shell uname -r<span class=k>)</span>/build

<span class=nf>all</span><span class=o>:</span>
    make -C <span class=k>$(</span>KDIR<span class=k>)</span> <span class=nv>M</span><span class=o>=</span><span class=k>$(</span>PWD<span class=k>)</span> modules
<span class=nf>clean</span><span class=o>:</span>
    make -C <span class=k>$(</span>KDIR<span class=k>)</span> <span class=nv>M</span><span class=o>=</span><span class=k>$(</span>PWD<span class=k>)</span> clean
</code></pre></td></tr></table></div></div><p>æ³¨æ„ï¼š<code>Makefile</code> çš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼Œå¦‚æœç¼©è¿›ä¸æ˜¯ <code>&lt;TAB></code> çš„è¯ï¼Œä¼šæŠ¥é”™ã€‚</p><pre><code>&lt;target&gt;: [ &lt;dependency &gt; ]*
       [ &lt;TAB&gt; &lt;command&gt; &lt;endl&gt; ]+
</code></pre><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># æŸ¥çœ‹å½“å‰æ–‡ä»¶</span>
root@0xDayServer:~/dev/kernel/hello# ls -l
total 8
-rw-r--r-- <span class=m>1</span> root root <span class=m>466</span> Mar  <span class=m>6</span> 22:53 hello.c
-rw-r--r-- <span class=m>1</span> root root <span class=m>154</span> Mar  <span class=m>6</span> 22:54 Makefile

<span class=c1># ç¼–è¯‘</span>
root@0xDayServer:~/dev/kernel/hello# make
make -C /lib/modules/4.4.0-93-generic/build/ <span class=nv>M</span><span class=o>=</span>/root/dev/kernel/hello modules
make<span class=o>[</span>1<span class=o>]</span>: Entering directory <span class=sb>`</span>/usr/src/linux-headers-4.4.0-93-generic<span class=s1>&#39;
</span><span class=s1>  CC [M]  /root/dev/kernel/hello/hello.o
</span><span class=s1>  Building modules, stage 2.
</span><span class=s1>  MODPOST 1 modules
</span><span class=s1>  CC      /root/dev/kernel/hello/hello.mod.o
</span><span class=s1>  LD [M]  /root/dev/kernel/hello/hello.ko
</span><span class=s1>make[1]: Leaving directory `/usr/src/linux-headers-4.4.0-93-generic&#39;</span>

<span class=c1># ç¼–è¯‘åç”Ÿæˆçš„æ¨¡å—æ–‡ä»¶</span>
root@0xDayServer:~/dev/kernel/hello# ls
hello.c  hello.ko  hello.mod.c  hello.mod.o  hello.o  Makefile  modules.order  Module.symvers
</code></pre></td></tr></table></div></div><h2 id=æµ‹è¯•æ¨¡å—>æµ‹è¯•æ¨¡å—</h2><h3 id=æŸ¥çœ‹æ¨¡å—ä¿¡æ¯>æŸ¥çœ‹æ¨¡å—ä¿¡æ¯</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>root@0xDayServer:~/dev/kernel/hello# modinfo hello.ko
filename:       /root/dev/kernel/hello/hello.ko
version:        0.1
description:    A simple Linux driver to say hello.
author:         WingLim
license:        GPL
srcversion:     093C7851C912088AEE5F77C
depends:        
vermagic:       4.4.0-93-generic SMP mod_unload modversions
</code></pre></td></tr></table></div></div><h3 id=åŠ è½½æ¨¡å—>åŠ è½½æ¨¡å—</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>root@0xDayServer:~/dev/kernel/hello# insmod hello.ko
root@0xDayServer:~/dev/kernel/hello# lsmod
Module                  Size  Used by
hello                  <span class=m>16384</span>  <span class=m>0</span> 
</code></pre></td></tr></table></div></div><h3 id=å¸è½½æ¨¡å—>å¸è½½æ¨¡å—</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>root@0xDayServer:~/dev/kernel/hello# rmmod hello
</code></pre></td></tr></table></div></div><h3 id=æŸ¥çœ‹-printk-è¾“å‡ºä¿¡æ¯>æŸ¥çœ‹ printk() è¾“å‡ºä¿¡æ¯</h3><ol><li>ä½¿ç”¨ <code>dmesg</code> å‘½ä»¤</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>root@0xDayServer:~/dev/kernel/hello# dmesg
<span class=o>[</span>100339.744628<span class=o>]</span> Hello LKM!
<span class=o>[</span>100432.211044<span class=o>]</span> Goodbye LKM!
</code></pre></td></tr></table></div></div><ol start=2><li>æŸ¥çœ‹å†…æ ¸æ—¥å¿—</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>root@0xDayServer:~/dev/kernel/hello# tail /var/log/kern.log
Mar  <span class=m>6</span> 22:58:16 0xDayServer kernel: <span class=o>[</span>100339.744628<span class=o>]</span> Hello LKM!
Mar  <span class=m>6</span> 22:59:49 0xDayServer kernel: <span class=o>[</span>100432.211044<span class=o>]</span> Goodbye LKM!
</code></pre></td></tr></table></div></div><h2 id=è‡ªå®šä¹‰å‚æ•°>è‡ªå®šä¹‰å‚æ•°</h2><p>å°† <code>hello.c</code> ä¿®æ”¹å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=cm>/*hello.c*/</span>
<span class=cp>#include</span> <span class=cpf>&lt;linux/init.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;linux/module.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;linux/kernel.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=n>MODULE_LICENSE</span><span class=p>(</span><span class=s>&#34;GPL&#34;</span><span class=p>);</span>
<span class=n>MODULE_AUTHOR</span><span class=p>(</span><span class=s>&#34;WingLim&#34;</span><span class=p>);</span>
<span class=n>MODULE_DESCRIPTION</span><span class=p>(</span><span class=s>&#34;A simple Linux driver to say hello.&#34;</span><span class=p>);</span>
<span class=n>MODULE_VERSION</span><span class=p>(</span><span class=s>&#34;0.1&#34;</span><span class=p>);</span>

<span class=k>static</span> <span class=kt>char</span> <span class=o>*</span><span class=n>name</span> <span class=o>=</span> <span class=s>&#34;LKM&#34;</span><span class=p>;</span>
<span class=n>module_param</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>charp</span><span class=p>,</span> <span class=n>S_IRUGO</span><span class=p>);</span>
<span class=n>MODULE_PARM_DESC</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=s>&#34;The name to display in /var/log/kern.log&#34;</span><span class=p>);</span>

<span class=k>static</span> <span class=kt>int</span> <span class=n>__init</span> <span class=nf>helloModule_init</span><span class=p>(</span><span class=kt>void</span><span class=p>){</span>
   <span class=n>printk</span><span class=p>(</span><span class=n>KERN_INFO</span> <span class=s>&#34;Hello %s!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span>
   <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>static</span> <span class=kt>void</span> <span class=n>__exit</span> <span class=nf>helloModule_exit</span><span class=p>(</span><span class=kt>void</span><span class=p>){</span>
   <span class=n>printk</span><span class=p>(</span><span class=n>KERN_INFO</span> <span class=s>&#34;Goodbye %s!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>module_init</span><span class=p>(</span><span class=n>helloModule_init</span><span class=p>);</span>
<span class=n>module_exit</span><span class=p>(</span><span class=n>helloModule_exit</span><span class=p>);</span>
</code></pre></td></tr></table></div></div><h3 id=è§£æ>è§£æ</h3><h4 id=static-char-name--lkm><code>static char *name = "LKM";</code></h4><p>å£°æ˜äº†ä¸€ä¸ªå…¨å±€é™æ€å­—ç¬¦æŒ‡é’ˆå˜é‡ <code>name</code>ï¼Œé»˜è®¤å€¼ä¸º<code>"LKM"</code></p><p>åœ¨å†…æ ¸æ¨¡å—ä¸­åº”è¯¥å°½é‡é¿å…ä½¿ç”¨å…¨å±€å˜é‡ï¼Œå› ä¸ºå…¨å±€å˜é‡ä¼šè¢«æ•´ä¸ªå†…æ ¸å…±äº«ã€‚æ‰€ä»¥åº”è¯¥ä½¿ç”¨ <code>static</code> æ¥é™åˆ¶å˜é‡åœ¨æ¨¡å—ä¸­çš„ä½œç”¨åŸŸï¼Œå¦‚æœä¸€å®šè¦ä½¿ç”¨å…¨å±€å˜é‡çš„è¯ï¼Œæœ€å¥½ç»™è¿™ä¸ªå˜é‡åŠ ä¸Šå‰ç¼€ï¼Œä»¥ç¡®ä¿å®ƒåœ¨å†…æ ¸ä¸­æ˜¯å”¯ä¸€çš„ã€‚</p><h4 id=module_paramname-type-permissions><code>module_param(name, type, permissions)</code></h4><p>å®šä¹‰åœ¨ <a href=https://elixir.bootlin.com/linux/v4.4/source/include/linux/moduleparam.h#L125>linux/moduleparam.h#L125</a></p><p><code>name</code> åå­—ï¼šå‘ç”¨æˆ·æ˜¾ç¤ºçš„å‚æ•°åç§°å’Œæ¨¡å—ä¸­çš„å˜é‡åç§°</p><p><code>type</code> å‚æ•°ç±»å‹ï¼šbyte, short, ushort, int, uint, long, ulong, charp, bool, invbool</p><p><code>permissions</code> æƒé™ï¼šå€¼ä¸º <code>0</code> æ—¶ï¼Œç¦ç”¨è¯¥é¡¹ï¼Œ<code>0444</code> æ‰€æœ‰äººå¯è¯»ï¼Œ<code>0644</code> rootç”¨æˆ·å¯å†™ï¼Œè¿™é‡Œçš„å†™æ³•å’Œæ–‡ä»¶æƒé™ä¸€è‡´ã€‚</p><h4 id=module_parm_desc>MODULE_PARM_DESC</h4><p>å‚æ•°æè¿°ï¼Œä¼šæ˜¾ç¤ºåœ¨ <code>modinfo</code> ä¸­</p><h3 id=è°ƒç”¨>è°ƒç”¨</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>root@0xDayServer:~/dev/kernel/hello# insmod hello.ko <span class=nv>name</span><span class=o>=</span>World
root@0xDayServer:~/dev/kernel/hello# dmesg
<span class=o>[</span>103386.179203<span class=o>]</span> Hello World!
</code></pre></td></tr></table></div></div><h2 id=å‚è€ƒ>å‚è€ƒ</h2><ul><li><a href=http://derekmolloy.ie/writing-a-linux-kernel-module-part-1-introduction/>Writing a Linux Kernel Module â€” Part 1: Introduction</a></li><li><a href=http://abcdxyzk.github.io/blog/2018/01/08/kernel-fpu-1/>linux ä¸‹çš„æµ®ç‚¹è¿ç®—</a></li><li><a href=https://book.douban.com/subject/1493443/>Linux Device Drivers : 3rd Edition</a></li></ul></div></div><div class=container><nav class="flex container suggested"><a rel=next href=/post/linux-kernel-practice-hijack-syscall/ title="Next post (newer)"><span>Next</span>
Linux Kernel å®è·µ(äºŒ)ï¼šåŠ«æŒç³»ç»Ÿè°ƒç”¨</a></nav></div></main></main><footer class="footer flex"><section class=container><nav class=footer-links><a href=/index.xml>RSS</a></nav></section><script async src=/js/features.min.d8434d46e16675f8f4dff694f2a0927e2796e44e068788db71a78952d647a7da.js></script></footer></body></html>