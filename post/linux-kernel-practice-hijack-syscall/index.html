<!doctype html><html lang=zh-cn>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover">
<link rel="shortcut icon" type=image/png href=/favicon.png>
<title>Linux Kernel 实践(二)：劫持系统调用 | 界限</title>
<script>(function(){let b=window.matchMedia('(prefers-color-scheme: dark)').matches===!0,c="light",a=a=>{document.documentElement.dataset.scheme=a};c=="dark"||b?a('dark'):a('light')})()</script>
<link rel=stylesheet href=/scss/style.min.5f0a890c9a05ae44aadf8526aa221f88dd83b90859c1047cf71bda536e75b1a1.css><script src=https://code.iconify.design/2/2.0.4/iconify.min.js></script>
<meta property="og:title" content="Linux Kernel 实践(二)：劫持系统调用 | 界限">
<meta property="og:description" content="通过劫持系统调用表，将原有系统调用替换成自定义系统调用">
<meta property="og:url" content="https://blog.limx.dev/post/linux-kernel-practice-hijack-syscall/">
<meta property="og:site_name" content="界限">
<meta property="og:type" content="article"><meta property="og:locale" content="zh-cn"><meta property="article:section" content="Post"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Kernel"><meta property="article:tag" content="Module"><meta property="article:published_time" content="2020-03-06T23:17:11+08:00"><meta property="article:modified_time" content="2020-03-06T23:17:11+08:00">
<meta name=twitter:card content="summary"><meta name=twitter:title content="Linux Kernel 实践(二)：劫持系统调用 | 界限">
<meta name=twitter:description content="通过劫持系统调用表，将原有系统调用替换成自定义系统调用">
</head>
<body><header class=header>
<div class=container>
<div class=header-content>
<a href=/ class=site-title-link><svg xmlns="http://www.w3.org/2000/svg" width="192" height="96"><path d="M23.74 66.86H16.49q.5-1.34 1.49-4.36Q18.97 59.48 20.21 55.57q1.24-3.91 2.51-7.98 1.27-4.07 2.35-7.67 1.08-3.59 1.81-5.98Q27.62 31.56 27.68 31.18 27.74 30.86 28.31 30.89 28.89 30.92 29.08 30.92h5.85Q35.06 30.92 34.71 31.4 34.36 31.88 34.17 31.88H31.49Q30.8 31.88 30.06 31.88 29.33 31.88 28.7 31.94 28.25 33.4 27.39 36.11 26.53 38.81 25.48 42.21q-1.04 3.41-2.16 7.03-1.11 3.63-2.13 6.96-1.02 3.34-1.81 5.89Q18.58 64.63 18.2 65.84h6.3Q24.63 65.84 24.28 66.32 23.93 66.79 23.74 66.86z" fill="#000"/><path d="M85.25 72.45Q83.53 72.45 80.79 71.4 78.06 70.36 74.82 68.67 71.57 66.98 68.36 65.14 65.15 63.3 62.48 61.64 59.81 59.99 58.28 58.97 57.58 60.5 56.37 62.72q-1.21 2.23-2.76 4.39-1.56 2.16-3.38 3.63Q48.42 72.2 46.39 72.2q-2.04.0-3.72-1.59Q40.98 69.02 39.68 66.54 38.37 64.06 37.48 61.23 36.59 58.4 36.15 55.85 35.7 53.31 35.7 51.66 35.7 51.4 35.73 50.8 35.77 50.19 35.96 49.65 36.15 49.11 36.53 49.11 36.97 49.11 36.97 49.65 36.97 50.19 36.97 50.51q0 1.72.32 3.91Q37.61 56.62 38.18 58.75q.57 2.13 1.27 3.72Q40.03 63.68 40.98 65.39 41.93 67.11 43.27 68.45q1.34 1.33 2.93 1.33Q47.79 69.78 49.28 68.32 50.78 66.86 52.02 64.73 53.26 62.6 54.18 60.53 55.1 58.46 55.61 57.25 54.59 56.62 52.78 55.5q-1.81-1.11-3.94-2.38Q46.7 51.85 44.54 50.7q-2.16-1.14-4-1.87Q38.69 48.1 37.55 48.1q-1.59.0-2.29 1.01Q34.56 50.13 34.56 51.66 34.56 52.55 34.81 53.44 35.07 54.33 35.07 55.22 35.07 55.35 35 55.79 34.94 56.24 34.62 56.24 34.3 56.24 34.02 55.38 33.73 54.52 33.6 53.57 33.48 52.61 33.48 52.29 33.48 50.58 34.02 49.02 34.56 47.46 35.77 46.44q1.2-1.02 3.05-1.02 1.84.0 4.26 1.05 2.42 1.05 4.96 2.61 2.54 1.56 4.77 3.15 2.23 1.59 3.75 2.67Q57.39 52.87 58.6 49.78q1.21-3.08 2.8-6.61 1.59-3.53 3.49-7 1.91-3.47 4.14-6.33 2.22-2.86 4.7-4.58 2.49-1.71 5.16-1.71Q80.54 23.55 81.56 24.4 82.58 25.26 83.08 26.73 83.15 26.92 83.18 27.11 83.21 27.3 83.21 27.49 83.21 28.51 82.67 29.56 82.13 30.61 81.43 31.31 81.37 31.37 81.11 31.59 80.86 31.81 80.73 31.81 80.54 31.81 80.54 31.56 80.54 31.05 80.73 30.57 80.92 30.1 80.92 29.59q0-1.66-1.02-3.02Q78.89 25.2 77.11 25.2 76.66 25.2 76.18 25.33 75.71 25.45 75.26 25.64 73.8 26.34 72.34 28.25q-1.47 1.91-2.83 4.49-1.37 2.57-2.58 5.27Q65.72 40.72 64.77 43.07 63.81 45.42 63.24 46.89q-1.02 2.48-1.97 4.96Q60.32 54.33 59.23 56.81 62.35 59.03 66.2 61.71 70.05 64.38 74.12 66.57 78.19 68.77 81.94 69.66 82.7 69.85 83.53 69.85 84.17 69.85 84.58 69.59 84.99 69.34 84.99 68.64 84.99 67.88 84.61 66.98 84.23 66.09 83.82 65.36 83.4 64.63 83.4 64.5 83.4 64.25 83.59 64.25 83.91 64.25 84.48 65.04 85.06 65.84 85.69 66.98 86.33 68.13 86.74 69.21 87.15 70.29 87.15 70.86 87.15 71.69 86.61 72.07 86.07 72.45 85.25 72.45z" fill="#000"/><path d="M103.6 66.86H95.97V66.79Q95.97 66.67 96.29 66.25 96.61 65.84 96.8 65.84h5.78Q102.97 64.63 103.79 62.09 104.62 59.54 105.7 56.2 106.78 52.87 107.96 49.24 109.14 45.62 110.25 42.21q1.11-3.4 1.97-6.1Q113.08 33.4 113.52 31.94 112.89 31.88 112.12 31.88 111.36 31.88 110.53 31.88h-2.92Q107.48 31.88 107.86 31.4 108.25 30.92 108.44 30.92h5.91Q115.11 30.92 115.05 31.18 114.86 31.56 114.06 33.94 113.27 36.33 112.09 39.92q-1.17 3.6-2.48 7.67Q108.31 51.66 107.07 55.57 105.83 59.48 104.91 62.5 103.98 65.52 103.6 66.86z" fill="#000"/><path d="M125.59 43.71Q125.4 43.71 125.37 43.23 125.33 42.75 125.33 42.63 125.33 42.44 125.4 41.8 125.46 41.16 125.78 41.1 126.67 40.97 127.56 40.78 128.45 40.59 129.34 40.34 129.47 40.27 129.72 40.27 130.04 40.27 130.04 40.59 130.04 41.29 129.18 42.02 128.32 42.75 127.27 43.23 126.22 43.71 125.59 43.71zM120.44 64.31q-3.12.0-3.12-3.18Q117.32 59.8 117.73 58.4 118.15 57 118.66 55.79 119.23 54.39 119.93 53.06 120.63 51.72 121.33 50.39 121.65 49.81 121.93 49.21 122.22 48.6 122.54 48.03 122.85 47.59 123.74 47.27 124.63 46.95 125.14 46.95 125.21 46.95 125.14 46.98L125.08 47.01H125.11Q125.14 47.01 125.14 47.08 125.27 46.95 125.46 46.95 125.72 46.95 125.78 47.17 125.84 47.4 125.84 47.59 125.84 48.03 125.49 48.92 125.14 49.81 124.67 50.61 124.19 51.4 123.74 51.59 123.17 52.93 122.25 54.52 121.33 56.11 120.56 57.73 119.8 59.35 119.8 60.88 119.8 62.66 121.71 62.66 122.6 62.66 123.65 62.09 124.7 61.52 125.72 60.72 126.73 59.93 127.46 59.35 128.2 58.78 128.39 58.78 128.45 58.78 128.45 58.81V58.84Q128.45 59.1 128.26 59.38 128.07 59.67 127.94 59.8 127.18 60.82 125.91 61.86 124.63 62.91 123.2 63.61 121.77 64.31 120.44 64.31zM126.48 65.27Q126.1 65.27 126.1 64.95 127.81 62.02 129.09 58.94 130.36 55.85 131.57 52.74L132.27 50.89Q132.27 50.7 131.92 50.77 131.57 50.83 131.57 50.58 131.57 50.45 132.11 49.59 132.65 48.73 133.22 47.81 133.79 46.89 133.92 46.7 134.17 46.31 135.07 45.93 135.96 45.55 136.4 45.55 137.04 45.55 137.04 46.12 137.04 46.31 136.43 47.75 135.83 49.18 135 51.12 134.17 53.06 133.48 54.74 132.78 56.43 132.58 57.13 133.09 56.49 134.24 55.25 135.38 54.01 136.85 52.55 138.31 51.08 139.84 49.75 141.36 48.41 142.6 47.55 143.84 46.7 144.54 46.7 145.11 46.7 145.27 47.17 145.43 47.65 145.43 48.1 145.43 49.3 144.89 51.15 144.35 52.99 143.65 54.84 142.95 56.68 142.44 57.83 143.71 56.75 145.21 55.31 146.7 53.88 148.1 52.36 149.5 50.83 150.39 49.49 150.9 48.86 151.6 48.86q1.34.0 1.34 1.27Q152.94 50.77 152.49 52.04 152.05 53.31 151.47 53.63 151.16 54.96 150.9 56.4q-.25 1.43-.25 2.89Q150.65 59.86 150.77 60.66 150.9 61.45 151.28 62.06 151.66 62.66 152.43 62.66 153.32 62.66 154.27 62.09 155.23 61.52 156.12 60.72 157.01 59.93 157.64 59.35 158.28 58.78 158.47 58.78 158.6 58.78 158.6 58.91 158.6 59.1 158.47 59.38 158.34 59.67 158.22 59.8 157.26 61.39 155.32 62.85q-1.94 1.46-3.91 1.46Q149.31 64.31 148.48 62.98 147.66 61.64 147.66 59.8 147.66 57.83 148.26 55.82 148.87 53.82 149.5 52.04 147.91 54.01 146.07 55.89 144.22 57.76 142.38 59.48 141.93 60.88 140.69 62.41 139.45 63.93 137.8 63.93 137.74 63.93 137.51 63.87 137.29 63.8 137.29 63.61V63.55Q137.29 63.49 137.35 63.49 137.8 62.28 138.53 60.56 139.26 58.84 140.06 56.94 140.85 55.03 141.39 53.31 141.93 51.59 141.93 50.45 141.93 50.26 141.9 50 141.87 49.75 141.55 49.75 140.98 49.75 139.93 50.67 138.88 51.59 137.61 53.02 136.34 54.46 135.1 55.98 133.86 57.51 132.9 58.75 131.95 59.99 131.63 60.5 130.61 61.96 129.79 63.55 129.66 63.87 128.99 64.28 128.32 64.7 127.59 64.98 126.86 65.27 126.48 65.27zm38.16-21.56Q164.45 43.71 164.42 43.23 164.38 42.75 164.38 42.63 164.38 42.44 164.45 41.8 164.51 41.16 164.83 41.1 165.72 40.97 166.61 40.78 167.5 40.59 168.39 40.34 168.52 40.27 168.77 40.27 169.09 40.27 169.09 40.59 169.09 41.29 168.23 42.02 167.37 42.75 166.32 43.23 165.28 43.71 164.64 43.71zM159.49 64.31q-3.12.0-3.12-3.18Q156.37 59.8 156.78 58.4 157.2 57 157.71 55.79 158.28 54.39 158.98 53.06 159.68 51.72 160.38 50.39 160.7 49.81 160.98 49.21 161.27 48.6 161.59 48.03 161.9 47.59 162.79 47.27 163.69 46.95 164.19 46.95 164.26 46.95 164.19 46.98L164.13 47.01H164.16Q164.19 47.01 164.19 47.08 164.32 46.95 164.51 46.95 164.77 46.95 164.83 47.17 164.89 47.4 164.89 47.59 164.89 48.03 164.54 48.92 164.19 49.81 163.72 50.61 163.24 51.4 162.79 51.59 162.22 52.93 161.3 54.52 160.38 56.11 159.61 57.73 158.85 59.35 158.85 60.88 158.85 62.66 160.76 62.66 161.65 62.66 162.7 62.09 163.75 61.52 164.77 60.72 165.78 59.93 166.52 59.35 167.25 58.78 167.44 58.78 167.5 58.78 167.5 58.81V58.84Q167.5 59.1 167.31 59.38 167.12 59.67 166.99 59.8 166.23 60.82 164.96 61.86 163.69 62.91 162.25 63.61 160.82 64.31 159.49 64.31zm10.36.0Q166.74 64.31 166.74 61.13 166.74 59.23 167.66 56.84 168.58 54.46 169.82 52.1 171.06 49.75 171.89 48.1 171 48.16 169.82 48.38 168.65 48.6 167.82 48.6 167.56 48.6 167.34 48.51 167.12 48.41 167.12 48.16 167.12 47.78 167.5 47.65 167.95 47.33 168.42 47.08 168.9 46.82 169.35 46.57 170.62 45.74 171.79 44.76 172.97 43.77 174.05 42.69 174.31 42.18 174.53 41.77 174.75 41.35 175.39 41.16 175.9 41.04 176.85 40.59 177.8 40.15 178.25 40.15 178.57 40.15 178.57 40.4 178.57 40.59 178.15 41.42 177.74 42.24 177.17 43.29 176.6 44.34 176.12 45.2 175.64 46.06 175.51 46.25 175.9 46.25 176.88 46.25 177.87 46.25 179.01 46.31 180.16 46.38 180.98 46.57 181.81 46.76 181.81 47.08 181.81 47.33 181.46 47.43 181.11 47.52 180.73 47.52 179.2 47.52 177.71 47.55 176.21 47.59 174.75 47.78 174.12 48.92 173.26 50.61 172.4 52.29 171.54 54.17 170.68 56.05 170.11 57.79 169.54 59.54 169.54 60.82 169.54 61.64 169.89 62.15 170.24 62.66 171.13 62.66 172.02 62.66 173.1 62.09 174.18 61.52 175.16 60.72 176.15 59.93 176.88 59.35 177.61 58.78 177.8 58.78 177.87 58.78 177.87 58.81V58.84Q177.87 59.1 177.71 59.38 177.55 59.67 177.42 59.8 176.6 60.82 175.32 61.86 174.05 62.91 172.62 63.61 171.19 64.31 169.85 64.31zM170.49 46.63Q171.06 46.51 171.6 46.47 172.14 46.44 172.65 46.38 172.84 45.93 172.97 45.49 173.1 45.04 173.23 44.6 172.53 45.04 171.86 45.58 171.19 46.12 170.49 46.63z" fill="#000"/></svg>
</a>
<nav class=navigation>
<ul>
<li>
<a class=nav-link href=/archives title=Archives>
<span class=iconify data-icon=fluent:archive-multiple-24-regular data-width=24 data-height=24></span>
<p class=use-title>Archives</p>
</a>
</li>
<li>
<a class=nav-link href=/feed.xml title=Feed>
<span class=iconify data-icon=fluent:rss-24-regular data-width=24 data-height=24></span>
<p class=use-title>Feed</p>
</a>
</li>
</ul>
</nav>
<div class=actions>
<div class=nav-toggle>
<div class=line></div>
<div class=line></div>
<div class=line></div>
</div>
</div>
</div>
</div>
</header><main class=page-content>
<div class="post-intro wrapper">
<h1 class=title>
Linux Kernel 实践(二)：劫持系统调用
</h1>
<p class=description>通过劫持系统调用表，将原有系统调用替换成自定义系统调用</p>
<div class=meta>
<div class="item date">
<span class=label>Published on</span>
<span class=value>March 06, 2020</span>
</div>
<div class=item>
<span class=label>Reading time</span>
<span class=value>5 minutes</span>
</div>
<div class=item>
<span class=label>Tags</span>
<span class=value>
<a href=/tags/linux/>#Linux</a>
<a href=/tags/kernel/>#Kernel</a>
<a href=/tags/module/>#Module</a>
</span>
</div>
</div>
</div>
<div class="wrapper contents">
<div class=toc>
<nav id=TableOfContents>
<ul>
<li><a href=#前言>前言</a></li>
<li><a href=#什么是系统调用表>什么是系统调用表</a></li>
<li><a href=#获取-sys_call_table-地址>获取 sys_call_table 地址</a>
<ul>
<li><a href=#暴力搜索>暴力搜索</a></li>
</ul>
</li>
<li><a href=#劫持系统调用>劫持系统调用</a>
<ul>
<li><a href=#写保护>写保护</a></li>
<li><a href=#模块代码>模块代码</a>
<ul>
<li><a href=#添加-makefile>添加 <code>Makefile</code></a></li>
<li><a href=#编译模块并启用>编译模块并启用</a></li>
<li><a href=#模块测试代码>模块测试代码</a></li>
<li><a href=#编译测试代码并测试>编译测试代码并测试</a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#尾语>尾语</a></li>
<li><a href=#参考>参考</a></li>
</ul>
</nav>
</div>
<div class=post-content>
<p>使用系统为 Ubuntu，内核版本为 4.4.0-93-generic</p>
<p>劫持系统调用有风险，请不要在实体机上尝试。</p>
<h2 id=前言>前言</h2>
<p>添加系统调用有两种方法</p>
<ul>
<li>修改内核源代码，并重新编译内核</li>
</ul>
<p>这种耗时耗力，比较麻烦，但是是在原有的系统调用中插入新的系统调用，不会出现冲突等问题。</p>
<ul>
<li>通过内核模块重新映射系统调用地址</li>
</ul>
<p>通过拦截系统调用表，将某个系统调用的地址修改成我们自定义的系统系统调用。</p>
<h2 id=什么是系统调用表>什么是系统调用表</h2>
<p>在 Linux 中每个系统调用都有相应的系统调用号作为唯一的标识，内核维护一张系统调用表：<code>sys_call_table</code>。</p>
<p>在 64 位系统中，<code>sys_call_table</code> 的定义在 <a href=https://elixir.bootlin.com/linux/v4.4/source/arch/x86/entry/syscall_64.c#L25>entry/syscall_64.c#L25</a></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>asmlinkage</span> <span class=k>const</span> <span class=n>sys_call_ptr_t</span> <span class=n>sys_call_table</span><span class=p>[</span><span class=n>__NR_syscall_max</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
    <span class=p>[</span><span class=mi>0</span> <span class=p>...</span> <span class=n>__NR_syscall_max</span><span class=p>]</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>sys_ni_syscall</span><span class=p>,</span>
<span class=cp>#include</span> <span class=cpf>&lt;asm/syscalls_64.h&gt;</span><span class=cp>
</span><span class=cp></span><span class=p>};</span>
</code></pre></div><p>其中 <code>#include &lt;asm/syscalls_64.h></code> 是通过 <a href=https://elixir.bootlin.com/linux/v4.4/source/arch/x86/entry/syscalls/Makefile#L50>entry/syscalls/Makefile</a> 以 <a href=https://elixir.bootlin.com/linux/v4.4/source/arch/x86/entry/syscalls/syscall_64.tbl>entry/syscalls/syscall_64.tbl</a> 为源文件编译生成的。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=nv>out</span> <span class=o>:=</span> <span class=k>$(</span>obj<span class=k>)</span>/../../include/generated/asm
<span class=nv>syscall64</span> <span class=o>:=</span> <span class=k>$(</span>srctree<span class=k>)</span>/<span class=k>$(</span>src<span class=k>)</span>/syscall_64.tbl
<span class=nv>systbl</span> <span class=o>:=</span> <span class=k>$(</span>srctree<span class=k>)</span>/<span class=k>$(</span>src<span class=k>)</span>/syscalltbl.sh
<span class=nf>$(out)/syscalls_64.h</span><span class=o>:</span> <span class=k>$(</span><span class=nv>syscall</span>64<span class=k>)</span> <span class=k>$(</span><span class=nv>systbl</span><span class=k>)</span>
    <span class=k>$(</span>call if_changed,systbl<span class=k>)</span>
</code></pre></div><p>Makefile 通过 <a href=https://elixir.bootlin.com/linux/v4.4/source/arch/x86/entry/syscalls/syscalltbl.sh>entry/syscalls/syscalltbl.sh</a> 将 <code>syscall_64.tbl</code> 格式化成 <code>__SYSCALL_${abi}($nr, $entry, $compat)</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=cp>#!/bin/sh
</span><span class=cp></span>
<span class=nv>in</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
<span class=nv>out</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span>

grep <span class=s1>&#39;^[0-9]&#39;</span> <span class=s2>&#34;</span><span class=nv>$in</span><span class=s2>&#34;</span> <span class=p>|</span> sort -n <span class=p>|</span> <span class=o>(</span>
    <span class=k>while</span> <span class=nb>read</span> nr abi name entry compat<span class=p>;</span> <span class=k>do</span>
    <span class=nv>abi</span><span class=o>=</span><span class=sb>`</span><span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$abi</span><span class=s2>&#34;</span> <span class=p>|</span> tr <span class=s1>&#39;[a-z]&#39;</span> <span class=s1>&#39;[A-Z]&#39;</span><span class=sb>`</span>
    <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$compat</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nb>echo</span> <span class=s2>&#34;__SYSCALL_</span><span class=si>${</span><span class=nv>abi</span><span class=si>}</span><span class=s2>(</span><span class=nv>$nr</span><span class=s2>, </span><span class=nv>$entry</span><span class=s2>, </span><span class=nv>$compat</span><span class=s2>)&#34;</span>
    <span class=k>elif</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$entry</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nb>echo</span> <span class=s2>&#34;__SYSCALL_</span><span class=si>${</span><span class=nv>abi</span><span class=si>}</span><span class=s2>(</span><span class=nv>$nr</span><span class=s2>, </span><span class=nv>$entry</span><span class=s2>, </span><span class=nv>$entry</span><span class=s2>)&#34;</span>
    <span class=k>fi</span>
    <span class=k>done</span>
<span class=o>)</span> &gt; <span class=s2>&#34;</span><span class=nv>$out</span><span class=s2>&#34;</span>
</code></pre></div><p>生成后的 <code>syscall_64.h</code> 内容截取如下：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>__SYSCALL_COMMON</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>sys_read</span><span class=p>,</span> <span class=n>sys_read</span><span class=p>)</span>
<span class=n>__SYSCALL_COMMON</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>sys_write</span><span class=p>,</span> <span class=n>sys_write</span><span class=p>)</span>
</code></pre></div><p>再看回 <code>entry/syscall_64.c</code>：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#define __SYSCALL_COMMON(nr, sym, compat) __SYSCALL_64(nr, sym, compat)
</span><span class=cp>#define __SYSCALL_64(nr, sym, compat) [nr] = sym,
</span></code></pre></div><p>所以可以得到 <code>sys_call_table</code> 的展开如下：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>asmlinkage</span> <span class=k>const</span> <span class=n>sys_call_ptr_t</span> <span class=n>sys_call_table</span><span class=p>[</span><span class=n>__NR_syscall_max</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
    <span class=p>[</span><span class=mi>0</span> <span class=p>...</span> <span class=n>__NR_syscall_max</span><span class=p>]</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>sys_ni_syscall</span><span class=p>,</span>
    <span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>sys_read</span><span class=p>,</span>
    <span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>sys_write</span><span class=p>,</span>
    <span class=p>...</span>
<span class=p>};</span>
</code></pre></div><p>所以可以把 <code>sys_call_table</code> 看作一个数组，索引为系统调用号，值为系统调用函数的起始地址。</p>
<h2 id=获取-sys_call_table-地址>获取 sys_call_table 地址</h2>
<ol>
<li>通过 <code>/boot/System.map</code> 获取</li>
<li>通过 <code>/proc/kallsyms</code> 获取</li>
<li>通过暴力搜索获取</li>
</ol>
<p>前面两种方式基本一致，都是通过读取文件并过滤的方式获取。</p>
<p><code>/boot/System.map</code> 包含整个内核镜像的符号表。</p>
<p><code>/proc/kallsyms</code> 不仅包含内核镜像符号表，还包含所有动态加载模块的符号表。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1># /boot/System.map</span>
root@0xDayServer:~# cat /boot/System.map-<span class=k>$(</span>uname -r<span class=k>)</span> <span class=p>|</span> grep sys_call_table
ffffffff81a001c0 R sys_call_table
ffffffff81a01520 R ia32_sys_call_table
<span class=c1># /proc/kallsyms</span>
root@0xDayServer:~# cat /proc/kallsyms <span class=p>|</span> grep sys_call_table
ffffffff81a001c0 R sys_call_table
ffffffff81a01520 R ia32_sys_call_table
</code></pre></div><p>如果要在 LKM 中 使用的话，可以将地址写在宏定义上，再进行调用。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#define SYS_CALL_TABLE  ffffffff81a001c0
</span></code></pre></div><p>但在不同的系统上都得进行修改并重新编译，非常麻烦。</p>
<h3 id=暴力搜索>暴力搜索</h3>
<p><strong>注意：在 Linux 内核 v4.17及之后 <code>sys_close</code> 就不再被导出。</strong></p>
<p>前面提到 <code>sys_call_table</code> 是一个数组，索引为系统调用号，值为系统调用函数的起始地址。</p>
<p>内核内存空间的起始地址 <code>PAGE_OFFSET</code> 变量和 <code>sys_close</code> 系统调用在内核模块中是可见的。系统调用号在同一<a href=https://en.wikipedia.org/wiki/Application_binary_interface>ABI</a>（x86与x64属于不同ABI）中是高度后向兼容的，可以直接引用（如 <code>__NR_close</code> ）。我们可以从内核空间起始地址开始，把每一个指针大小的内存假设成 <code>sys_call_table</code> 的地址，并用 <code>__NR_close</code> 索引去访问它的成员，如果这个值与 <code>sys_close</code> 的地址相同的话，就可以认为找到了 <code>sys_call_table</code> 的地址。</p>
<p>更多有关 <code>PAGE_OFFSET</code> 的内容请看：<a href=https://geneblue.github.io/2017/04/02/android/sec--linux-kernel-arm64-virtual-address-space/>ARM64 Linux 内核虚拟地址空间</a></p>
<p>下面来看搜索 <code>sys_call_table</code> 的函数：</p>
<p><code>ULONG_MAX</code> 为 0xFFFFFFFFUL，即 <code>unsigned long</code> 的最大值</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>**</span><span class=nf>get_sys_call_table</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>**</span><span class=n>entry</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>**</span><span class=p>)</span><span class=n>PAGE_OFFSET</span><span class=p>;</span>

  <span class=k>for</span> <span class=p>(;(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span><span class=n>entry</span> <span class=o>&lt;</span> <span class=n>ULONG_MAX</span><span class=p>;</span> <span class=n>entry</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>entry</span><span class=p>[</span><span class=n>__NR_close</span><span class=p>]</span> <span class=o>==</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)</span><span class=n>sys_close</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>entry</span><span class=p>;</span>
      <span class=p>}</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><h2 id=劫持系统调用>劫持系统调用</h2>
<h3 id=写保护>写保护</h3>
<p>当我们获取到了 <code>sys_call_table</code> 的地址时，并不能直接进行操作，会报错且无法写入，因为在内存中有写保护，这个特性可以通过 <a href=https://en.wikipedia.org/wiki/Control_register#CR0>CR0</a> 寄存器控制。</p>
<p>CR0 的第16位比特是写保护，设置时，即使权限级别为0（Linux 有4个权限级别，从0到3，0为最高级。等级0也被称为内核模式），也不能写入只读页。</p>
<p>我们可以通过 <a href=https://elixir.bootlin.com/linux/v4.4/ident/read_cr0>read_cr0</a> 和 <a href=https://elixir.bootlin.com/linux/v4.4/ident/write_cr0>write_cr0</a> 这两个函数，来读取和写入 CR0，同时通过 Linux 内核提供的接口 <a href=https://www.kernel.org/doc/htmldocs/kernel-api/API-set-bit.html>set_bit</a> 和 <a href=https://www.kernel.org/doc/htmldocs/kernel-api/API-clear-bit.html>clear_bit</a> 来操作比特。</p>
<p>关闭写保护，将第16个比特置为0。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=nf>disable_write_protection</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>cr0</span> <span class=o>=</span> <span class=n>read_cr0</span><span class=p>();</span>
  <span class=n>clear_bit</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>cr0</span><span class=p>);</span>
  <span class=n>write_cr0</span><span class=p>(</span><span class=n>cr0</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>开启写保护，将第16个比特置为1。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=nf>enable_write_protection</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>cr0</span> <span class=o>=</span> <span class=n>read_cr0</span><span class=p>();</span>
  <span class=n>set_bit</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>cr0</span><span class=p>);</span>
  <span class=n>write_cr0</span><span class=p>(</span><span class=n>cr0</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><h3 id=模块代码>模块代码</h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cm>/**
</span><span class=cm> * @file    nice.c
</span><span class=cm> * @author  WingLim
</span><span class=cm> * @date    2020-03-05
</span><span class=cm> * @version 0.1
</span><span class=cm> * @brief  读取及修改一个进程的 nice 值，并返回最新的 nice 值及优先级 prio 的模块化实现
</span><span class=cm>*/</span>

<span class=cp>#include</span> <span class=cpf>&lt;linux/init.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;linux/kernel.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;linux/module.h&gt;</span><span class=cp>
</span><span class=cp></span><span class=c1>// 下面这些头文件为自定义系统调用要用到的
</span><span class=c1></span><span class=cp>#include</span> <span class=cpf>&lt;linux/pid.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;linux/sched.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;linux/syscalls.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;linux/uaccess.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;linux/unistd.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=c1>// 这里是随便挑了一个系统调用来劫持，224 为 timer_gettime
</span><span class=c1></span><span class=cp>#define the_syscall_num 224
</span><span class=cp></span>
<span class=n>MODULE_LICENSE</span><span class=p>(</span><span class=s>&#34;GPL&#34;</span><span class=p>);</span>
<span class=n>MODULE_AUTHOR</span><span class=p>(</span><span class=s>&#34;WingLim&#34;</span><span class=p>);</span>
<span class=n>MODULE_DESCRIPTION</span><span class=p>(</span><span class=s>&#34;A module to read or set nice value&#34;</span><span class=p>);</span>
<span class=n>MODULE_VERSION</span><span class=p>(</span><span class=s>&#34;0.1&#34;</span><span class=p>);</span>

<span class=c1>// 用于保存 sys_call_table 地址
</span><span class=c1></span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>**</span><span class=n>sys_call_table</span><span class=p>;</span>
<span class=c1>// 用于保存被劫持的系统调用
</span><span class=c1></span><span class=k>static</span> <span class=nf>int</span> <span class=p>(</span><span class=o>*</span><span class=n>anything_saved</span><span class=p>)(</span><span class=kt>void</span><span class=p>);</span>

<span class=c1>// 从内核起始地址开始搜索内存空间来获得 sys_call_table 的内存地址
</span><span class=c1></span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>**</span><span class=nf>get_sys_call_table</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>**</span><span class=n>entry</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>**</span><span class=p>)</span><span class=n>PAGE_OFFSET</span><span class=p>;</span>

  <span class=k>for</span> <span class=p>(;(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span><span class=n>entry</span> <span class=o>&lt;</span> <span class=n>ULONG_MAX</span><span class=p>;</span> <span class=n>entry</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>entry</span><span class=p>[</span><span class=n>__NR_close</span><span class=p>]</span> <span class=o>==</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)</span><span class=n>sys_close</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>entry</span><span class=p>;</span>
      <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>disable_write_protection</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>cr0</span> <span class=o>=</span> <span class=n>read_cr0</span><span class=p>();</span>
  <span class=n>clear_bit</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>cr0</span><span class=p>);</span>
  <span class=n>write_cr0</span><span class=p>(</span><span class=n>cr0</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>enable_write_protection</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>cr0</span> <span class=o>=</span> <span class=n>read_cr0</span><span class=p>();</span>
  <span class=n>set_bit</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>cr0</span><span class=p>);</span>
  <span class=n>write_cr0</span><span class=p>(</span><span class=n>cr0</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// 这个是用来获取进程的 prio，代码来自 task_prio
</span><span class=c1>// 因为这个函数没有导出，所以拷贝一份到源码里
</span><span class=c1></span><span class=kt>int</span> <span class=nf>get_prio</span><span class=p>(</span><span class=k>const</span> <span class=k>struct</span> <span class=n>task_struct</span> <span class=o>*</span><span class=n>p</span><span class=p>)</span>
<span class=p>{</span>
        <span class=k>return</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>prio</span> <span class=o>-</span> <span class=n>MAX_RT_PRIO</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>asmlinkage</span> <span class=kt>long</span> <span class=nf>sys_setnice</span><span class=p>(</span><span class=n>pid_t</span> <span class=n>pid</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flag</span><span class=p>,</span> <span class=kt>int</span> <span class=n>nicevalue</span><span class=p>,</span> <span class=kt>int</span> <span class=n>__user</span> <span class=o>*</span> <span class=n>prio</span><span class=p>,</span> <span class=kt>int</span> <span class=n>__user</span> <span class=o>*</span> <span class=n>nice</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>struct</span> <span class=n>pid</span> <span class=o>*</span> <span class=n>kpid</span><span class=p>;</span>
        <span class=k>struct</span> <span class=n>task_struct</span> <span class=o>*</span> <span class=n>task</span><span class=p>;</span>
        <span class=kt>int</span> <span class=n>nicebef</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>priobef</span><span class=p>;</span>
        <span class=n>kpid</span> <span class=o>=</span> <span class=n>find_get_pid</span><span class=p>(</span><span class=n>pid</span><span class=p>);</span> <span class=c1>// 获取 pid
</span><span class=c1></span>        <span class=n>task</span> <span class=o>=</span> <span class=n>pid_task</span><span class=p>(</span><span class=n>kpid</span><span class=p>,</span> <span class=n>PIDTYPE_PID</span><span class=p>);</span> <span class=c1>// 返回 task_struct
</span><span class=c1></span>        <span class=n>nicebef</span> <span class=o>=</span> <span class=n>task_nice</span><span class=p>(</span><span class=n>task</span><span class=p>);</span> <span class=c1>// 获取进程当前 nice 值
</span><span class=c1></span>    <span class=n>priobef</span> <span class=o>=</span> <span class=n>get_prio</span><span class=p>(</span><span class=n>task</span><span class=p>);</span> <span class=c1>// 获取进程当前 prio 值
</span><span class=c1></span>
        <span class=k>if</span><span class=p>(</span><span class=n>flag</span> <span class=o>==</span> <span class=mi>1</span><span class=p>){</span>
                <span class=n>set_user_nice</span><span class=p>(</span><span class=n>task</span><span class=p>,</span> <span class=n>nicevalue</span><span class=p>);</span>
                <span class=n>printk</span><span class=p>(</span><span class=s>&#34;nice value edit before：%d</span><span class=se>\t</span><span class=s>edit after：%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>nicebef</span><span class=p>,</span> <span class=n>nicevalue</span><span class=p>);</span>
                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=n>flag</span> <span class=o>==</span> <span class=mi>0</span><span class=p>){</span>
                <span class=n>copy_to_user</span><span class=p>(</span><span class=n>nice</span><span class=p>,</span> <span class=p>(</span><span class=k>const</span> <span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>nicebef</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>nicebef</span><span class=p>));</span>
                <span class=n>copy_to_user</span><span class=p>(</span><span class=n>prio</span><span class=p>,</span> <span class=p>(</span><span class=k>const</span> <span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>priobef</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>priobef</span><span class=p>));</span>
                <span class=n>printk</span><span class=p>(</span><span class=s>&#34;nice of the process：%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>nicebef</span><span class=p>);</span>
                <span class=n>printk</span><span class=p>(</span><span class=s>&#34;prio of the process：%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>priobef</span><span class=p>);</span>
                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=n>printk</span><span class=p>(</span><span class=s>&#34;the flag is undefined!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
        <span class=k>return</span> <span class=n>EFAULT</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>static</span> <span class=kt>int</span> <span class=n>__init</span> <span class=nf>init_addsyscall</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
    <span class=c1>// 关闭写保护
</span><span class=c1></span>    <span class=n>disable_write_protection</span><span class=p>();</span>
    <span class=c1>// 获取系统调用表的地址
</span><span class=c1></span>    <span class=n>sys_call_table</span> <span class=o>=</span> <span class=n>get_sys_call_table</span><span class=p>();</span>
    <span class=c1>// 保存原始系统调用的地址
</span><span class=c1></span>    <span class=n>anything_saved</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=kt>void</span><span class=p>))</span> <span class=p>(</span><span class=n>sys_call_table</span><span class=p>[</span><span class=n>the_syscall_num</span><span class=p>]);</span>
    <span class=c1>// 将原始的系统调用劫持为自定义系统调用
</span><span class=c1></span>    <span class=n>sys_call_table</span><span class=p>[</span><span class=n>the_syscall_num</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=o>*</span><span class=p>)</span><span class=n>sys_setnice</span><span class=p>;</span>
    <span class=c1>// 恢复写保护
</span><span class=c1></span>    <span class=n>enable_write_protection</span><span class=p>();</span>
    <span class=n>printk</span><span class=p>(</span><span class=s>&#34;hijack syscall success</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>static</span> <span class=kt>void</span> <span class=n>__exit</span> <span class=nf>exit_addsyscall</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// 关闭写保护
</span><span class=c1></span>    <span class=n>disable_write_protection</span><span class=p>();</span>
    <span class=c1>// 恢复原来的系统调用
</span><span class=c1></span>    <span class=n>sys_call_table</span><span class=p>[</span><span class=n>the_syscall_num</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=o>*</span><span class=p>)</span><span class=n>anything_saved</span><span class=p>;</span>
    <span class=c1>// 恢复写保护
</span><span class=c1></span>    <span class=n>enable_write_protection</span><span class=p>();</span>
    <span class=n>printk</span><span class=p>(</span><span class=s>&#34;resume syscall</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>module_init</span><span class=p>(</span><span class=n>init_addsyscall</span><span class=p>);</span>
<span class=n>module_exit</span><span class=p>(</span><span class=n>exit_addsyscall</span><span class=p>);</span>
</code></pre></div><h4 id=添加-makefile>添加 <code>Makefile</code></h4>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=nv>obj-m</span><span class=o>+=</span>nice.o
<span class=nv>KDIR</span> <span class=o>=</span> /lib/modules/<span class=k>$(</span>shell uname -r<span class=k>)</span>/build

<span class=nf>all</span><span class=o>:</span>
    make -C <span class=k>$(</span>KDIR<span class=k>)</span> <span class=nv>M</span><span class=o>=</span><span class=k>$(</span>PWD<span class=k>)</span> modules
<span class=nf>clean</span><span class=o>:</span>
    make -C <span class=k>$(</span>KDIR<span class=k>)</span> <span class=nv>M</span><span class=o>=</span><span class=k>$(</span>PWD<span class=k>)</span> clean
</code></pre></div><h4 id=编译模块并启用>编译模块并启用</h4>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1># 编译</span>
root@0xDayServer:~/dev/kernel/nice# make
make -C /lib/modules/4.4.0-93-generic/build/ <span class=nv>M</span><span class=o>=</span>/root/dev/kernel/nice modules
make<span class=o>[</span>1<span class=o>]</span>: Entering directory <span class=sb>`</span>/usr/src/linux-headers-4.4.0-93-generic<span class=s1>&#39;
</span><span class=s1>  CC [M]  /root/dev/kernel/nice/nice.o
</span><span class=s1>  Building modules, stage 2.
</span><span class=s1>  MODPOST 1 modules
</span><span class=s1>  CC      /root/dev/kernel/nice/nice.mod.o
</span><span class=s1>  LD [M]  /root/dev/kernel/nice/nice.ko
</span><span class=s1>make[1]: Leaving directory `/usr/src/linux-headers-4.4.0-93-generic&#39;</span>
<span class=c1># 插入模块</span>
root@0xDayServer:~/dev/kernel/nice# insmod nice.ko
</code></pre></div><h4 id=模块测试代码>模块测试代码</h4>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cm>/*test.c*/</span>
<span class=cp>#define _GNU_SOURCE
</span><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/syscall.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#define __NR_mysetnice 224 </span><span class=c1>//系统调用号
</span><span class=c1></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>pid_t</span> <span class=n>tid</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>nicevalue</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>prio</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>nice</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=n>tid</span> <span class=o>=</span> <span class=n>getpid</span><span class=p>();</span>
    <span class=n>syscall</span><span class=p>(</span><span class=n>__NR_mysetnice</span><span class=p>,</span><span class=n>tid</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=o>-</span><span class=mi>5</span><span class=p>,</span><span class=o>&amp;</span><span class=n>prio</span><span class=p>,</span><span class=o>&amp;</span><span class=n>nice</span><span class=p>);</span><span class=c1>//read
</span><span class=c1></span>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;pid: %d</span><span class=se>\n</span><span class=s>prio: %d</span><span class=se>\n</span><span class=s>nice: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>tid</span><span class=p>,</span> <span class=n>prio</span><span class=p>,</span><span class=n>nice</span><span class=p>);</span>
    <span class=n>syscall</span><span class=p>(</span><span class=n>__NR_mysetnice</span><span class=p>,</span><span class=n>tid</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=o>-</span><span class=mi>5</span><span class=p>,</span><span class=o>&amp;</span><span class=n>prio</span><span class=p>,</span><span class=o>&amp;</span><span class=n>nice</span><span class=p>);</span><span class=c1>//set
</span><span class=c1></span>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;pid: %d</span><span class=se>\n</span><span class=s>prio: %d</span><span class=se>\n</span><span class=s>nice: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>tid</span><span class=p>,</span> <span class=n>prio</span><span class=p>,</span><span class=n>nice</span><span class=p>);</span>
    <span class=n>syscall</span><span class=p>(</span><span class=n>__NR_mysetnice</span><span class=p>,</span><span class=n>tid</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=o>-</span><span class=mi>5</span><span class=p>,</span><span class=o>&amp;</span><span class=n>prio</span><span class=p>,</span><span class=o>&amp;</span><span class=n>nice</span><span class=p>);</span><span class=c1>//read
</span><span class=c1></span>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;pid: %d</span><span class=se>\n</span><span class=s>prio: %d</span><span class=se>\n</span><span class=s>nice: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>tid</span><span class=p>,</span> <span class=n>prio</span><span class=p>,</span><span class=n>nice</span><span class=p>);</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;*******************************</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=n>syscall</span><span class=p>(</span><span class=n>__NR_mysetnice</span><span class=p>,</span><span class=n>tid</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=o>-</span><span class=mi>15</span><span class=p>,</span><span class=o>&amp;</span><span class=n>prio</span><span class=p>,</span><span class=o>&amp;</span><span class=n>nice</span><span class=p>);</span><span class=c1>//read
</span><span class=c1></span>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;pid: %d</span><span class=se>\n</span><span class=s>prio: %d</span><span class=se>\n</span><span class=s>nice: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>tid</span><span class=p>,</span> <span class=n>prio</span><span class=p>,</span><span class=n>nice</span><span class=p>);</span>
    <span class=n>syscall</span><span class=p>(</span><span class=n>__NR_mysetnice</span><span class=p>,</span><span class=n>tid</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=o>-</span><span class=mi>15</span><span class=p>,</span><span class=o>&amp;</span><span class=n>prio</span><span class=p>,</span><span class=o>&amp;</span><span class=n>nice</span><span class=p>);</span><span class=c1>//set
</span><span class=c1></span>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;pid: %d</span><span class=se>\n</span><span class=s>prio: %d</span><span class=se>\n</span><span class=s>nice: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>tid</span><span class=p>,</span> <span class=n>prio</span><span class=p>,</span><span class=n>nice</span><span class=p>);</span>
    <span class=n>syscall</span><span class=p>(</span><span class=n>__NR_mysetnice</span><span class=p>,</span><span class=n>tid</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=o>-</span><span class=mi>15</span><span class=p>,</span><span class=o>&amp;</span><span class=n>prio</span><span class=p>,</span><span class=o>&amp;</span><span class=n>nice</span><span class=p>);</span><span class=c1>//read
</span><span class=c1></span>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;pid: %d</span><span class=se>\n</span><span class=s>prio: %d</span><span class=se>\n</span><span class=s>nice: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>tid</span><span class=p>,</span> <span class=n>prio</span><span class=p>,</span><span class=n>nice</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><h4 id=编译测试代码并测试>编译测试代码并测试</h4>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1># 编译 test.c</span>
root@0xDayServer:~/dev/kernel/nice# gcc test.c -o <span class=nb>test</span>
<span class=c1># 执行</span>
root@0xDayServer:~/dev/kernel/nice# ./test
pid: <span class=m>12872</span>
prio: <span class=m>20</span>
nice: <span class=m>0</span>
pid: <span class=m>12872</span>
prio: <span class=m>20</span>
nice: <span class=m>0</span>
pid: <span class=m>12872</span>
prio: <span class=m>15</span>
nice: -5
*******************************
pid: <span class=m>12872</span>
prio: <span class=m>15</span>
nice: -5
pid: <span class=m>12872</span>
prio: <span class=m>15</span>
nice: -5
pid: <span class=m>12872</span>
prio: <span class=m>5</span>
nice: -15
<span class=c1># 查看模块输出信息</span>
root@0xDayServer:~/dev/kernel/nice# tail /var/log/kern.log
Mar  <span class=m>7</span> 03:52:47 0xDayServer kernel: <span class=o>[</span>118009.435431<span class=o>]</span> nice of the process：0
Mar  <span class=m>7</span> 03:52:47 0xDayServer kernel: <span class=o>[</span>118009.435434<span class=o>]</span> prio of the process：20
Mar  <span class=m>7</span> 03:52:47 0xDayServer kernel: <span class=o>[</span>118009.435466<span class=o>]</span> nice value edit before：0   edit after：-5
Mar  <span class=m>7</span> 03:52:47 0xDayServer kernel: <span class=o>[</span>118009.435475<span class=o>]</span> nice of the process：-5
Mar  <span class=m>7</span> 03:52:47 0xDayServer kernel: <span class=o>[</span>118009.435476<span class=o>]</span> prio of the process：15
Mar  <span class=m>7</span> 03:52:47 0xDayServer kernel: <span class=o>[</span>118009.435481<span class=o>]</span> nice of the process：-5
Mar  <span class=m>7</span> 03:52:47 0xDayServer kernel: <span class=o>[</span>118009.435481<span class=o>]</span> prio of the process：15
Mar  <span class=m>7</span> 03:52:47 0xDayServer kernel: <span class=o>[</span>118009.435485<span class=o>]</span> nice value edit before：-5  edit after：-15
Mar  <span class=m>7</span> 03:52:47 0xDayServer kernel: <span class=o>[</span>118009.435494<span class=o>]</span> nice of the process：-15
Mar  <span class=m>7</span> 03:52:47 0xDayServer kernel: <span class=o>[</span>118009.435495<span class=o>]</span> prio of the process：5
</code></pre></div><h2 id=尾语>尾语</h2>
<p>这里提到的劫持系统调用，是 RootKit 中的一部分，RootKit 是一组工具，目标是隐藏它自身存在并继续向攻击者提供系统访问。所以我们可以通过劫持系统调用来做一些更有趣的事情，比如劫持 <code>sys_open</code> 来监视文件的创建。</p>
<p>同时，获取 <code>sys_call_table</code> 也有很多其他方式，比如 IDT（Interrupt Descriptor Table）、MSRs（Model-Specific Registers）在参考三中有它们的实现方式，总之，Linux Kernel 还挺有趣的，接下来再继续探索更多可玩的地方。</p>
<h2 id=参考>参考</h2>
<ul>
<li><a href=https://zhuanlan.zhihu.com/p/55214097>Linux系统调用流程</a></li>
<li><a href=https://docs-conquer-the-universe.readthedocs.io/zh_CN/latest/linux_rootkit/sys_call_table.html>Linux Rootkit 系列二：基于修改 sys_call_table 的系统调用挂钩</a></li>
<li><a href=https://github.com/oblique/articles/blob/master/kernel_mode_hooking/tutorial.english.txt>Kernel Mode Hooking Tutorial</a></li>
<li><a href=https://zhuanlan.zhihu.com/p/31342840>OS 实验一 | linux 内核编译及添加系统调用</a></li>
</ul>
</div>
</div>
<div class="wrapper comments">
<div id=cusdis_thread data-host=https://cusdis.limxw.com data-app-id=d5c63066-e952-4a1d-8844-0a9f9796d97d data-page-id=055458efca71469af7e10813a6ec9c3e data-page-url=https://blog.limx.dev/post/linux-kernel-practice-hijack-syscall/ data-page-title="Linux Kernel 实践(二)：劫持系统调用"></div>
<script async defer src=https://cusdis.limxw.com/js/cusdis.es.js></script>
<script>let setCusdisTheme=a=>{let b=document.querySelector('#cusdis_thread iframe');b&&window.CUSDIS.setTheme(a)};window.addEventListener('colorSchemeChange',a=>{setCusdisTheme(a.detail)})</script>
</div>
</main><footer class=footer>
<div class=footer-rows>
<section class=copyright>
&copy; 2021 界限
</section>
<section class=powerby>
Powered by
<a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a>
</section>
</div>
</footer><script type=text/javascript src=/ts/script.cd2f157bd7ad4e6fa77a36a13780f122cbaaaa68a1d4154890c9187dd68b674a.js defer></script></body>
</html>